<script type="text/javascript" src="/js/jquery.validate.min.js"></script>

		<!-- Contents step1 -->
		<div class="mp-contents" id="corpDiv">
            <div class="mp-tit">
                <h2>Profile</h2>
                <p class="desc">Please enter the following details to participate in presale. <br>Please double-check whether you have entered the correct information as it cannot be modified once registered. All details must be in English and identical to the uploaded documents.</p>
            </div>
            <section class="mp-section step">
                <div class="step-head cf">
                    <div class="s-tit">
                        <em class="n">Step 1</em><span class="t">Company information</span>
                    </div>
                    <div class="step">
                        <ul>
                            <li class="active">1</li>
                            <li>2</li>
                        </ul>
                    </div>
                </div>
                <div class="step-body">
                    <form id="corpProfileForm" name="corpProfileForm">
                        <!-- input[type=hidden] 은 여기에 넣으세요 -->
                        <div class="form-row-group first">
                            <div class="span5 form-row">
                                <label class="fm-label" for="companyNm">Company name</label>
                                <div class="fm-input">
                                    <input type="text" id="companyNm" name="companyNm" placeholder="Must match with company registration certificate">
                                </div>
                            </div>
                            <div class="span5 form-row">
                                <label class="fm-label" for="taxNo">Private company registration number</label>
                                <div class="fm-input">
                                    <input type="text" id="taxNo" name="taxNo" placeholder="Must match with company registration certificate">
                                </div>
                            </div>
                        </div>
                        <div class="form-row-group">
                            <div class="span5 form-row">
                                <label class="fm-label" for="companyNo">Incorporated company registration number</label>
                                <div class="fm-input">
                                    <input type="text" id="companyNo" name="companyNo" placeholder="Must match with company registration certificate">
                                </div>
                            </div>
                            <div class="span5 form-row">
                                <label class="fm-label" for="corpAbode">Company location</label> 
                                <div class="fm-select">
                                    <select id="corpAbode" name="corpAbode">
                                        <option value="">Select</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-row-group">
                            <div class="span5 form-row">
                                <label class="fm-label" for="addr1">Address 1</label>
                                <div class="fm-input">
                                    <input type="text" id="addr1" name="addr1"placeholder="">
                                </div>
                            </div>
                            <div class="span5 form-row">
                                <label class="fm-label" for="addr2">Address 2</label>
                                <div class="fm-input">
                                    <input type="text" id="addr2" name="addr2" placeholder="">
                                </div>
                            </div>
                        </div>
                        <div class="form-row-group">
                            <div class="span5 form-row">
                                <label class="fm-label" for="gugun">State</label>
                                <div class="fm-input">
                                    <input type="text" id="gugun" name="gugun"placeholder="">
                                </div>
                            </div>
                            <div class="span5 form-row">
                                <div class="form-row-group">
                                    <div class="span7 form-row">
                                        <label class="fm-label" for="sido">City</label>
                                        <div class="fm-input">
                                            <input type="text" id="sido" name="sido" placeholder="">
                                        </div>
                                    </div>
                                    <div class="span3 form-row">
                                        <label class="fm-label" for="zipcode">Zip code</label>
                                        <div class="fm-input">
                                            <input type="text" id="zipcode" name="zipcode" placeholder="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row-group">
                            <div class="span5 form-row only">
                                <label class="fm-label" for="">Shareholders</label>
                                <div class="fm-expand">
                                    <div class="inset">
                                        <div class="ex-wrap">
                                            <div class="fm-input">
                                                <input type="text" id="inShName" oninput="checkShareSholder('inShName', false)" placeholder="Enter the name of sahreholders" class="ignore">
                                            </div>
                                            <div class="fm-input">
                                                <input type="text" id="inShUserSeq" oninput="checkShareSholder('inShUserSeq', false)" placeholder="Enter membership no" class="ignore">
                                            </div>
                                            <button type="button" id="btnAdd" class="btn expand plus">plus</button>
                                        </div>
                                        <!-- <p class="error">Enter your contact number.</p>에러메세지 -->
                                        <ul class="list" id="shareholderList">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn-wrap">
                            <button type="button" class="btn bu next" id="corpProceed">Proceed</button>
                        </div>
                    </form>
                </div>
            </section>
            <div class="precaution">
                <div class="tit">Precaution</div>
                <ul class="list">
                    <li><span class="num">1.</span><span class="txt">All shareholders with stake more than 20% must register.</span></li>
                    <li><span class="num">2.</span><span class="txt">If there is no shareholder with stake more than 20%, the top five shareholders must register.</span></li>
                    <li><span class="num">3.</span><span class="txt">All shareholders who need to register must sign-up individually, enter profile, and proceed with KYC.</span></li>    
                </ul>
            </div>
    
        </div>
        <!-- //Contents -->
    
		<!-- Contents step2 -->
		<div class="mp-contents" id="corpFileDiv" style="display:none;">
            <div class="mp-tit">
                <h2>Profile</h2>
                <p class="desc">Upload the relevant company documents. All details must be in English. If not, English translation notarization is required.<br>Please double-check and upload the documents as it cannot be changed in the future.</p>
            </div>
            <section class="mp-section step">
                <div class="step-head cf">
                    <div class="s-tit">
                        <em class="n">Step 2</em><span class="t">Company information</span>
                    </div>
                    <div class="step">
                        <ul>
                            <li>1</li>
                            <li class="active">2</li>
                        </ul>
                    </div>
                </div>
                <div class="step-body">
                    <form id="corpProfileFileForm" name="corpProfileFileForm">
                        <!-- input[type=hidden] 은 여기에 넣으세요 -->
                        <div class="form-row-group first">
                            <div class="span5 form-row"id="taxFileDiv">
                                <label class="fm-label" for="">Company registration certificate</label>
                                <div class="fm-file" >
                                    <div class="fm-input">
                                        <input type="text" id="taxFileText" onclick="$('#taxFile').click();" placeholder="Upload file" readonly>
                                    </div>
                                    <button type="button" class="btn search fixed" id="btntaxFile" onclick="$('#taxFile').click();">Search</button>
                                    <input type="file" id="taxFile" name="taxFile" onchange="fnBtnTextChange('taxFile');">
                                </div>
                            </div>
                            <div class="span5 form-row" id="shareHolderFileDiv">
                                <label class="fm-label" for="">Shareholder list</label>
                                <div class="fm-file">
                                    <div class="fm-input">
                                        <input type="text" id="shareHolderFileText" onclick="$('#shareHolderFile').click();" placeholder="Upload file" readonly>
                                    </div>
                                    <button type="button" class="btn search fixed" id="btnshareHolderFile" onclick="$('#shareHolderFile').click();">Search</button>
                                    <input type="file" id="shareHolderFile" name="shareHolderFile" onchange="fnBtnTextChange('shareHolderFile');">
                                </div>
                            </div>
                        </div>
                        <div class="form-row-group">
                            <div class="span5 form-row" id="delegateFileDiv">
                                <label class="fm-label" for="">Power of attorney from the company representative</label>
                                <div class="fm-file">
                                    <div class="fm-input">
                                        <input type="text" id="delegateFileText" onclick="$('#delegateFile').click();" placeholder="Upload file" readonly>
                                    </div>
                                    <button type="button" class="btn search fixed" id="btndelegateFile" onclick="$('#delegateFile').click();">Search</button>
                                    <input type="file" id="delegateFile" name="delegateFile" onchange="fnBtnTextChange('delegateFile');">
                                </div>
                            </div>
                            <div class="span5 form-row" id="etcFileDiv">
                                <label class="fm-label" for="">Others (Optional)</label>
                                <div class="fm-file">
                                    <div class="fm-input">
                                        <input type="text" id="etcFileText" onclick="$('#etcFile').click();" placeholder="Upload file" readonly>
                                    </div>
                                    <button type="button" class="btn search fixed" id="btnetcFile" onclick="$('#etcFile').click();">Search</button>
                                    <input type="file" id="etcFile" name="etcFile" onchange="fnBtnTextChange('etcFile');">
                                </div>
                            </div>
                        </div>
                        <div class="btn-wrap">
                            <button type="button" class="btn bu prev" onclick="fnBack()">Back</button>
                            <button type="button" class="btn confirm fixed" onclick="$('#corpProfileFileForm').submit();">Save</button>
                        </div>
                    </form>
                </div>
            </section>
            <div class="precaution">
                <div class="tit">Precaution</div>
                <ul class="list">
                    <li><span class="num">1.</span><span class="txt">To upload any additional documents such as the authentication certificate of company seal etc., please upload on 'Others'.</span></li>
                    <li><span class="num">2.</span><span class="txt">If your uploaded files are unclear, you may need to scan and submit again.</span></li>
                    <li><span class="num">3.</span><span class="txt">Only the files with less than 3 MB / jpg, pdf, and doc formats are allowed.</span></li>
                </ul>
            </div>
        </div>
        <!-- //Contents -->

<script>
    $(function() {
        $("[name='lProfile']").addClass("active");
        $("#mMenuLayer").text("Profile");

        getMemberProfileInfo();

        // 주주정보 추가
        $(document).on('click', "#btnAdd", function() {
            var shareHolderFlg = true;
            if ($.trim($("#inShName").val()) == '') {
                shareHolderFlg = false;
                checkShareSholder('inShName', false);
            } else {
                $("#inShName").parent().removeClass("sh-error");
                $("#inShName-sh-error").remove();
            }
            if ($.trim($("#inShUserSeq").val()) == '') {
                shareHolderFlg = false;
                checkShareSholder('inShUserSeq', false);
            } else {
                $("#inShUserSeq").parent().removeClass("sh-error");
                $("#inShUserSeq-sh-error").remove();
            }
            if (!shareHolderFlg) {
                return;
            }
            
            // 회원번호 유효성 체크
            var inShuserSeqVal = $("#inShUserSeq").val();
            var nextFlg = true;
            $("[name='shUserSeq[]']").each(function(idx) {
                if ($(this).val() === inShuserSeqVal) {
                    nextFlg = false;
                    $("#inShUserSeq").parent('div').append("<label id='inShUserSeq-sh-error' class='sh-error' for='inShUserSeq'>Duplicated member number</label>");
                    return;
                }
            });
            if (nextFlg) {
                $.ajax({
                    url: '/mypage/checkShareHolderAjax',
                    data: {'shareholderSeq': inShuserSeqVal}, 
                    type: 'POST',
                    dataType: 'json',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', "Bearer " + token);
                    },
                    success: function(data){
                        data.refToken ? localStorage.setItem('access_token', data.refToken) : '';
                        if (data.cnt > 0) {
                            var divLen = $("#shareholderList > li").length;
                        // if (divLen < 5) {    // 무제한...
                            var shareHolderHtml = "";
                            shareHolderHtml += "<li>";
                            shareHolderHtml += "    <div class='ex-wrap'>";
                            shareHolderHtml += "        <div class='fm-input'>";
                            shareHolderHtml += "            <input type='text' name='shName[]' id='shName_" + divLen + "' value='" + $("#inShName").val() + "' placeholder='Enter the name of sahreholders' readonly>";
                            shareHolderHtml += "        </div>";
                            shareHolderHtml += "        <div class='fm-input'>";
                            shareHolderHtml += "            <input type='text' name='shUserSeq[]' id='shUserSeq_" + divLen + "' value='" + $("#inShUserSeq").val() + "' placeholder='Enter membership no' readonly>";
                            shareHolderHtml += "        </div>";
                            shareHolderHtml += "        <button type='button' id='btnRemove' class='btn expand minus'>minus</button>";
                            shareHolderHtml += "    </div>";
                            shareHolderHtml += "</li>";
                            $("#shareholderList").prepend(shareHolderHtml);
                        // } else {
                        //     alert("주주정보는 최대 5개까지 추가 가능합니다.");
                        //     return;
                        // }
                            $("#inShName").val('');
                            $("#inShUserSeq").val('');
                        } else {
                            $("#inShUserSeq").parent('div').append("<label id='inShUserSeq-sh-error' class='sh-error' for='inShUserSeq'>Please check your membership number.</label>");
                        }
                    }
                    , error: function(error) {
                        alert('Error occurred.');
                    }
                });
            }
            
        });
        
        // 주주정보 삭제
        $(document).on('click', "#btnRemove", function() {
            $(this).parent().parent().remove();
        });

        var shareholderChkFlg
        $("#corpProceed").click(function() {
            shareholderChkFlg = preShareholderCheck();
            $('#corpProfileForm').submit();
        });
        
        $("#corpProfileForm").validate({
            rules: {
                companyNm: "required"
                , taxNo: "required"
                , companyNo: "required"
                , corpAbode: "required"
                , addr1: "required"
                , addr2: "required"
                , gugun: "required"
                , sido: "required"
                , zipcode: "required"
            },
            messages: {
                companyNm: "Enter company name."
                , taxNo: "Enter private company registration number."
                , companyNo: "Enter incorporated company registration number."
                , corpAbode: "Select company location."
                , addr1: "Enter company address."
                , addr2: "Enter company address."
                , gugun: "Enter county and district."
                , sido: "Enter city and province."
                , zipcode: "Enter zip code."
            },
            highlight: function(element, errorClass) {
                if (errorClass == "error") {
                    $(element).parent().addClass("error");
                }
            },
            errorPlacement: function(err, el) {
                el.after(err);
                var errCls = el.attr("class");
                if (errCls == "error") {
                    $(el).parent().addClass("error");
                }
            },
            success: function(el) {
                $(el).parent().removeClass("error");
            },
            submitHandler: function (form) {
                if (!shareholderChkFlg) {
                    return;
                }

                $.ajax({
                    url: '/mypage/updateCorpProfileAjax',
                    data: $("#corpProfileForm").serialize(), 
                    type: 'POST',
                    dataType: 'json',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', "Bearer " + token);
                    },
                    success: function(data){
                        data.refToken ? localStorage.setItem('access_token', data.refToken) : '';
                        if (data.result) {
                            $("#corpDiv").hide();
                            $("#corpFileDiv").show();
                        } else {
                            if (data.loginFlg) {
                                location.href = '/login';
                            } else {
                                alert(data.message);
                            }
                        }
                        headerFooterPosition();
                    }
                    , error: function(error) {
                        alert('Error occurred');
                    }
                });
            }
        });

        // 입력 파일 체크
        $.validator.addMethod("fileCheck", function (value, element, param) {
            var checkId = element.id;
            $("[name='" + checkId + "_name']").remove();
            if (checkId != "etcFile" || element.value != "") {
                if (value.toLowerCase().match(new RegExp("." + param.toLowerCase() + "$")) && (this.optional(element) || (element.files[0].size < (3*1024*1024)))) {
                    return true;
                } else {
                    $("#" + checkId + "Div").append("<label id='" + checkId + "-error' name='" + checkId + "_name' class='error'>Only files with less than 3MB / jpg, pdf and doc formats are allowed.</label>");
                    return false;
                }
            }
            if (checkId == "etcFile" || element.value == "") {
                return true;
            }
        }, '');

        // 파일 업로드
        $("#corpProfileFileForm").validate({
            rules: {
                taxFile: {
                    fileCheck: "jpg|jpeg|pdf"
                }
                , shareHolderFile: {
                    fileCheck: "jpg|jpeg|pdf"
                }
                , delegateFile: {
                    fileCheck: "jpg|jpeg|pdf"
                }
                , etcFile: {
                    fileCheck: "jpg|jpeg|pdf"
                }
            },
            submitHandler: function (form) {
                var formData = new FormData();
                formData.append("taxFile", $("input[name='taxFile']")[0].files[0]);
                formData.append("shareHolderFile", $("input[name='shareHolderFile']")[0].files[0]);
                formData.append("delegateFile", $("input[name='delegateFile']")[0].files[0]);
                // formData.append("proofFile", $("input[name='proofFile']")[0].files[0]);
                formData.append("etcFile", $("input[name='etcFile']")[0].files[0]);

                $.ajax({
                    url: '/mypage/corpProfileFileUploadAjax',
                    data: formData, 
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', "Bearer " + token);
                    },
                    success: function(data){
                        data.refToken ? localStorage.setItem('access_token', data.refToken) : '';
                        if (data.result) {
                            location.href = "/mypage/profile";
                        } else {
                            if (data.loginFlg) {
                                location.href = '/login';
                            } else {
                                alert(data.message);
                            }
                        }
                    }
                    , error: function(error) {
                        alert('Error occurred.');
                    }
                });
            }
        });
    });

    function preShareholderCheck() {
        if ($("#shareholderList > li").length > 0) {
            $("#inShName").parent().removeClass("sh-error");
            $("#inShName-sh-error").remove();
            $("#inShUserSeq").parent().removeClass("sh-error");
            $("#inShUserSeq-sh-error").remove();
            return true;
        } else {
            checkShareSholder("inShName", true);
            checkShareSholder("inShUserSeq", true);
            alertFlg = true;
            return false
        }
    }
    
    var alertFlg = true;
    function checkShareSholder(id, nextCheckFlg) {
        $("#" + id).parent().removeClass("sh-error");
        $("#" + id + "-sh-error").remove();
        if ($.trim($("#" + id).val()) == '' || nextCheckFlg) {
            if ($("#shareholderList > li").length == 0 && alertFlg) {
                alert("Enter the details of the shareholder and click the ‘+’ button.");
                alertFlg = false;
                return false;
            } else {
                if (alertFlg) {
                    $("#" + id).parent().addClass("sh-error");
                    var errText = id == 'inShName' ? 'Enter shareholder name.' : 'Enter membership number.';
                    $("#" + id).parent('div').append("<label id='" + id + "-sh-error' class='sh-error' for='" + id + "'>" + errText + "</label>");
                }
            }
        }
    }

    var countries;

    // 2. 회원 프로파일 정보 조회
    function getMemberProfileInfo() {
        $.ajax({
            url: '/mypage/getMemberProfileInfoAjax',
            type: 'POST',
            dataType: 'json',
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', "Bearer " + token);
            },
            success: function(data){
                data.refToken ? localStorage.setItem('access_token', data.refToken) : '';
                if (data.result) {
                    var memProfileList = data.memProfile;    // 주주 복수 대응
                    var memProfile = memProfileList[0];
                    if (memProfile && memProfile.userd_type == 'C') {  // 법인
                        // 프로파일 등록 완료인 경우
                        if (memProfile.complete_yn == 'Y' || memProfile.completeSep > 1) {
                            // 정보 확인 페이지 이동
                            location.href = '/mypage/profileCorpStep1';
                        } else {
                            // 초기 값 설정
                            $("#companyNm").val(memProfile.company_nm);
                            $("#taxNo").val(memProfile.tax_no);
                            $("#companyNo").val(memProfile.company_no);
                            data.abode.filter(function(item) {
                                var selectedYn = item.code == memProfile.corpAbode ? 'selected' : '';
                                var abodeOptionHtml = "<option value='" + item.code + "' " + selectedYn + ">" + item.name + "</option>";
                                $("#corpAbode").append(abodeOptionHtml);
                            });
                            $("#addr1").val(memProfile.addr1);
                            $("#addr2").val(memProfile.addr2);
                            $("#gugun").val(memProfile.gugun);
                            $("#sido").val(memProfile.sido);
                            $("#zipcode").val(memProfile.zipcode);

                            $("#shareholderList").empty();
                            var shareHolderHtml = "";
                            for (var i = 0; i < memProfileList.length; i++) {
                                var item = memProfileList[i];
                                var shName = item.sh_name ? item.sh_name : '';
                                var shUserSeq = item.sh_user_seq ? item.sh_user_seq : '';
                                if (shName != "") {
                                    shareHolderHtml += "<li>";
                                    shareHolderHtml += "    <div class='ex-wrap'>";
                                    shareHolderHtml += "        <div class='fm-input'>";
                                    shareHolderHtml += "            <input type='text' name='shName[]' id='shName_" + i + "' value='" + shName + "' placeholder='Enter the name of sahreholders' readonly>";
                                    shareHolderHtml += "        </div>";
                                    shareHolderHtml += "        <div class='fm-input'>";
                                    shareHolderHtml += "            <input type='text' name='shUserSeq[]' id='shUserSeq_" + i + "' value='" + shUserSeq + "' placeholder='Enter membership no' readonly>";
                                    shareHolderHtml += "        </div>";
                                    shareHolderHtml += "        <button type='button' id='btnRemove' class='btn expand minus'>minus</button>";
                                    shareHolderHtml += "    </div>";
                                    shareHolderHtml += "</li>";
                                }
                            }
                            $("#shareholderList").append(shareHolderHtml);
                            if (memProfile.completeSep == '1') {
                                $("#corpFileDiv").show();   // 법인 파일 등록
                                $("#corpDiv").hide();
                            } else {
                                $("#corpFileDiv").hide();
                                $("#corpDiv").show();       // 기본 정보
                            }
                        }
                    }
                } else {
                    if (data.loginFlg) {
                        location.href = '/login';
                    } else {
                        alert(data.message);
                    }
                }
                headerFooterPosition();
            }
            , error: function(error) {
                alert('Error occurred.');
            }
        });
    }

    function fnBtnTextChange(id) {
        var file = $("#" + id)[0].files[0];
        $("#" + id + "Text").val(file.name);

        $("#btn" + id).text("delete");
        $("#btn" + id).removeClass("search");
        $("#btn" + id).addClass("delete");
        $("#btn" + id).attr("onclick", "fnBtnDelete('" + id + "')");
        $("[name='" + id + "_name']").remove();

    }

    function fnBtnDelete(id) {
        $("#" + id).val("");
        $("#" + id + "Text").val("");
        $("#btn" + id).text("search");
        $("#btn" + id).removeClass("delete");
        $("#btn" + id).addClass("search");
        $("#btn" + id).attr("onclick", "$('#" + id + "').click();");
    }

    function fnBack() {
        $("#inShName").val();
        $("#inShUserSeq").val();
        $("#corpFileDiv").hide();
        $("#corpDiv").show();
        headerFooterPosition();
    }

    // 파일 삭제
    function fileDelete(id) {
        $("#" + id).val('');
    }

    function setStep(info) {
        // if (info.completeSep == '4') {
        //     location.href = '/mypage/tokenSale2';
        // } else if (info.completeSep > 0) {
        //     if (loginFlg) {
        //         location.href = '/mypage/tokenSale' + (parseInt(info.completeSep) + 1);
        //     } else {
        //         location.href = '/mypage/profileCorpStep' + (parseInt(info.profileStep) + 1);
        //     }
        // } else {
        //     if (info.completeYn == 'Y' && loginFlg) {
        //         window.location.href = '/mypage/tokenSale' + (parseInt(info.completeSep) + 1);
        //     } else {
                
        //     }
        // }
        headerFooterPosition(); // 회면 사이즈 재확인
    }

</script>